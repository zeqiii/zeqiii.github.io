<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Analysis of cve-2016-0848  &middot; Zeqi&#39;s Blog</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="description" />

<meta name="keywords" content="Vulnerability, ">


<meta property="og:title" content="Analysis of cve-2016-0848  &middot; Zeqi&#39;s Blog ">
<meta property="og:site_name" content="Zeqi&#39;s Blog"/>
<meta property="og:url" content="https://zeqiii.github.io/2016/04/15/analysis-of-cve-2016-0848/" />
<meta property="og:locale" content="en-EN">


<meta property="og:type" content="article" />
<meta property="og:description" content="description"/>
<meta property="og:article:published_time" content="2016-04-15T16:43:07&#43;08:00" />
<meta property="og:article:modified_time" content="2016-04-15T16:43:07&#43;08:00" />

  
    
<meta property="og:article:tag" content="Vulnerability">
    
  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@" />
<meta name="twitter:title" content="Analysis of cve-2016-0848" />
<meta name="twitter:description" content="description" />
<meta name="twitter:url" content="https://zeqiii.github.io/2016/04/15/analysis-of-cve-2016-0848/" />
<meta name="twitter:domain" content="https://zeqiii.github.io/">
  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "Analysis of cve-2016-0848",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+?rel=author"
    },
    "datePublished": "2016-04-15",
    "description": "description",
    "wordCount":  1054 
  }
</script>



<link rel="canonical" href="https://zeqiii.github.io/2016/04/15/analysis-of-cve-2016-0848/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://zeqiii.github.io/touch-icon-144-precomposed.png">
<link href="https://zeqiii.github.io/favicon.png" rel="icon">

<meta name="generator" content="Hugo 0.15" />

  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link href='https://fonts.googleapis.com/css?family=Merriweather:300%7CRaleway%7COpen+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://zeqiii.github.io/css/font-awesome.min.css">
<link rel="stylesheet" href="https://zeqiii.github.io/css/style.css">
<link rel="stylesheet" href="https://zeqiii.github.io/css/highlight/default.css">

  
</head>
<body>
  <main id="main-wrapper" class="container main_wrapper has-sidebar">
    <header id="main-header" class="container main_header">
  <div class="container brand">
  <div class="container title h1-like">
  <a class="baselink" href="https://zeqiii.github.io/">
  Zeqi&#39;s Blog

</a>

</div>

  
<div class="container topline">
  

</div>


</div>

  <nav class="container nav primary no-print">
  

<a class="homelink" href="https://zeqiii.github.io/">Home</a>


  
<a href="https://zeqiii.github.io/post" title="Show list of posts">Posts</a>

<a href="https://zeqiii.github.io/tags" title="Show list of tags">Tags</a>

<a href="https://zeqiii.github.io/topics" title="Show list of topics">Topics</a>


</nav>

<div class="container nav secondary no-print">
  
<a id="contact-link-email" class="contact_link" href="mailto:zeqiii@163.com">
  <span class="fa fa-envelope-square"></span><span>email</span></a>



<a id="contact-link-github" class="contact_link" href="https://github.com/zeqiii">
  <span class="fa fa-github-square"></span><span>github</span></a>

















</div>


  

</header>


<article id="main-content" class="container main_content single">
  <header class="container hat">
  <h1>Analysis of cve-2016-0848
</h1>

  <div class="metas">
<time datetime="2016-04-15">15 Apr, 2016</time>


  
    &middot; by zeqi
  
  &middot; Read in about 5 min
  &middot; (1054 Words)
  <br>
  
<a class="label" href="https://zeqiii.github.io/tags/vulnerability">Vulnerability</a>



</div>

</header>

  <div class="container content">
  

<h2 id="introduction">Introduction</h2>

<p>In the April security bulletin of Android, cve-2016-0848 is also disclosed. Let&rsquo;s analysis it!</p>

<h2 id="start-from-the-patch">Start From the Patch</h2>

<p>The patch consists of two parts, one is in DownloadProvider.java, the other is in Helpers.java.</p>

<p>In DownloadProvider.java, the patch changes function <code>openFile()</code>.</p>

<pre><code class="language-java">-        final File file = new File(path);
+        final File file;
+        try {
+            file = new File(path).getCanonicalFile();
+        } catch (IOException e) {
+            throw new FileNotFoundException(e.getMessage());
+        }
+
         if (!Helpers.isFilenameValid(getContext(), file)) {
-            throw new FileNotFoundException(&quot;Invalid file: &quot; + file);
+            throw new FileNotFoundException(&quot;Invalid file path: &quot; + file);
         }
</code></pre>

<p>In Helpers.java, the patch changes function <code>isFilenameValid()</code>.</p>

<pre><code class="language-java">     static boolean isFilenameValid(Context context, File file) {
         final File[] whitelist;
         try {
-            file = file.getCanonicalFile();
             whitelist = new File[] {
                     context.getFilesDir().getCanonicalFile(),
                     context.getCacheDir().getCanonicalFile(),
</code></pre>

<p>Before being patched, the object <code>file = new File(path)</code> in <code>openFile()</code> is not changed even it is passed to <code>isFilenameValid()</code>, because the reassignment in <code>isFilenameValid()</code> has no effect on the <code>file</code> object in the outer function. So the <code>file</code> in <code>openFile()</code> may not be canonical.</p>

<p>After being patched, <code>file = new File(path).getCanonicalFile()</code> is done in the <code>openFile</code> before <code>isFilenameValid()</code> being called, so the object <code>file</code> will be a canonical file throughout this function.</p>

<h2 id="how-downloadprovider-works">How DownloadProvider Works</h2>

<h3 id="demo">Demo</h3>

<p>I write a program:</p>

<pre><code class="language-java">// test download
downloadManager = (DownloadManager) getSystemService(Context.DOWNLOAD_SERVICE);
id = downloadManager.enqueue(new DownloadManager.Request(Uri.parse(&quot;http://pic25.nipic.com/20121108/9252150_160744284000_2.jpg&quot;)));
</code></pre>

<p>This program downloads an image from the Internet. After being execute, a record will be added into <code>com.android.providers.downloads</code>&rsquo;s database.</p>

<p>According the <code>AndroidManifest.xml</code> in <code>/packages/Providers/DownloadProviders/</code>, the package name of the system component where DownloadProvider exists is &laquo;com.android.providers.downloads&raquo;.</p>

<p>Run <code>adb shell pm dump com.android.providers.downloads</code>, to find the data path: <code>dataDir=/data/user/0/com.android.providers.downloads</code>.</p>

<p>Copy the database file from <code>%dataDir/databases/</code> to the computer and open it with any one of the sqlite tools, we will see all the download information.</p>

<p><img src="/img/cve-2016-0848/downloads_db.png" alt="downloads.db" /></p>

<h3 id="work-flow-analysis">Work flow analysis</h3>

<p>Code of <code>DownloadManager.enqueue()</code>:</p>

<pre><code class="language-java">public long enqueue(Request request) {
    ContentValues values = request.toContentValues(mPackageName);
    Uri downloadUri = mResolver.insert(Downloads.Impl.CONTENT_URI, values);
    long id = Long.parseLong(downloadUri.getLastPathSegment());
    return id;
}
</code></pre>

<p><code>mPackageName</code> is a field, it is assigned by the constructor, which is invisible to the developer:</p>

<pre><code class="language-java">/**
 * @hide
 */
public DownloadManager(ContentResolver resolver, String packageName) {
    mResolver = resolver;
    mPackageName = packageName;
}
</code></pre>

<p><strong>So how a DownloadManager is initialized?</strong></p>

<p><code>SystemServiceRegistry</code> registers DownloadManager.</p>

<pre><code class="language-java">registerService(Context.DOWNLOAD_SERVICE, DownloadManager.class,
    new CachedServiceFetcher&lt;DownloadManager&gt;() {
        @Override
        public DownloadManager createService(ContextImpl ctx) {
            return new DownloadManager(ctx.getContentResolver(), ctx.getPackageName());
        }
    }
);

private static &lt;T&gt; void registerService(String serviceName, Class&lt;T&gt; serviceClass, ServiceFetcher&lt;T&gt; serviceFetcher) {
    SYSTEM_SERVICE_NAMES.put(serviceClass, serviceName);
    SYSTEM_SERVICE_FETCHERS.put(serviceName, serviceFetcher);
}

// Service registry information.
// This information is never changed once static initialization has completed.
private static final HashMap&lt;Class&lt;?&gt;, String&gt; SYSTEM_SERVICE_NAMES =
        new HashMap&lt;Class&lt;?&gt;, String&gt;();
private static final HashMap&lt;String, ServiceFetcher&lt;?&gt;&gt; SYSTEM_SERVICE_FETCHERS =
        new HashMap&lt;String, ServiceFetcher&lt;?&gt;&gt;();
</code></pre>

<p>The overrided function <code>createService()</code> is called by <code>ServiceFetcher.getService()</code>:</p>

<pre><code class="language-java">static abstract class CachedServiceFetcher&lt;T&gt; implements ServiceFetcher&lt;T&gt; {
    private final int mCacheIndex;

    public CachedServiceFetcher() {
        mCacheIndex = sServiceCacheSize++;
    }

    @Override
    @SuppressWarnings(&quot;unchecked&quot;)
    public final T getService(ContextImpl ctx) {
        final Object[] cache = ctx.mServiceCache;
        synchronized (cache) {
            // Fetch or create the service.
            Object service = cache[mCacheIndex];
            if (service == null) {
                service = createService(ctx);
                cache[mCacheIndex] = service;
            }
            return (T)service;
        }
    }

    public abstract T createService(ContextImpl ctx);
}
</code></pre>

<p>When one calls <code>getSystemService(String name)</code> in his application, he calls <code>getSystemService(String name)</code> in <code>ContextImpl</code>:</p>

<pre><code class="language-java">public Object getSystemService(String name) {
    return SystemServiceRegistry.getSystemService(this, name);
}
</code></pre>

<p><code>getSystemService(ContextImpl ctx, String name)</code> in <code>SystemServiceRegistry</code>:</p>

<pre><code class="language-java">public static Object getSystemService(ContextImpl ctx, String name) {
    ServiceFetcher&lt;?&gt; fetcher = SYSTEM_SERVICE_FETCHERS.get(name);
    return fetcher != null ? fetcher.getService(ctx) : null;
}
</code></pre>

<p>So, <code>mPackageName</code> is initialized in this way above.</p>

<p>** Back to the function enqueue() **</p>

<pre><code class="language-java">public long enqueue(Request request) {
    ContentValues values = request.toContentValues(mPackageName);
    Uri downloadUri = mResolver.insert(Downloads.Impl.CONTENT_URI, values);
    long id = Long.parseLong(downloadUri.getLastPathSegment());
    return id;
}
</code></pre>

<p><code>request.toContentValues(mPackageName)</code> resolve the application information who calls DownloadManager, and wrap the information into a ContentValues object.</p>

<pre><code class="language-java">ContentValues toContentValues(String packageName) {
    ContentValues values = new ContentValues();
    assert mUri != null;
    values.put(Downloads.Impl.COLUMN_URI, mUri.toString());
    values.put(Downloads.Impl.COLUMN_IS_PUBLIC_API, true);
    values.put(Downloads.Impl.COLUMN_NOTIFICATION_PACKAGE, packageName);

    if (mDestinationUri != null) {
        values.put(Downloads.Impl.COLUMN_DESTINATION, Downloads.Impl.DESTINATION_FILE_URI);
        values.put(Downloads.Impl.COLUMN_FILE_NAME_HINT, mDestinationUri.toString());
    } else {
        values.put(Downloads.Impl.COLUMN_DESTINATION, (this.mUseSystemCache) ?
            Downloads.Impl.DESTINATION_SYSTEMCACHE_PARTITION :
            Downloads.Impl.DESTINATION_CACHE_PARTITION_PURGEABLE);
    }
    // is the file supposed to be media-scannable?
    values.put(Downloads.Impl.COLUMN_MEDIA_SCANNED, (mScannable) ? SCANNABLE_VALUE_YES : SCANNABLE_VALUE_NO);

    if (!mRequestHeaders.isEmpty()) {
        encodeHttpHeaders(values);
    }

    putIfNonNull(values, Downloads.Impl.COLUMN_TITLE, mTitle);
    putIfNonNull(values, Downloads.Impl.COLUMN_DESCRIPTION, mDescription);
    putIfNonNull(values, Downloads.Impl.COLUMN_MIME_TYPE, mMimeType);

    values.put(Downloads.Impl.COLUMN_VISIBILITY, mNotificationVisibility);
    values.put(Downloads.Impl.COLUMN_ALLOWED_NETWORK_TYPES, mAllowedNetworkTypes);
    values.put(Downloads.Impl.COLUMN_ALLOW_ROAMING, mRoamingAllowed);
    values.put(Downloads.Impl.COLUMN_ALLOW_METERED, mMeteredAllowed);
    values.put(Downloads.Impl.COLUMN_IS_VISIBLE_IN_DOWNLOADS_UI, mIsVisibleInDownloadsUi);

    return values;
}
</code></pre>

<p>The value of <code>CONTENT_URI</code> is:</p>

<pre><code class="language-java">public static final Uri CONTENT_URI = Uri.parse(&quot;content://downloads/my_downloads&quot;)
</code></pre>

<p>So <code>mResolver.insert(Downloads.Impl.CONTENT_URI, values)</code> invokes the insert method of <code>DownloadProvider</code>.</p>

<p>This is the component definition in <code>AndroidManifest.xml</code>:</p>

<p>``java
<provider android:name=".DownloadProvider" 
          android:authorities="downloads" android:exported="true">
  <!-- Anyone can access /my_downloads, the provider internally restricts access by UID for these URIs -->
  <path-permission android:pathPrefix="/my_downloads"
                   android:permission="android.permission.INTERNET"/>
  &hellip;
</provider></p>

<pre><code>
The ``insert()`` of ``DownloadProvider`` will insert an item to the ``downloads.db``, and the ``DownloadService`` will finish the download task.

### openFile(Uri uri, String mode) ###

``openFile(Uri uri, String mode)`` is an abstract fucntion of ``ContentProvider``, subclasses inherited from ContentProvider should implement this function to provide access of content files to others application.

Here is the ``openFile()`` of ``DownloadProvider``:

```java
public ParcelFileDescriptor openFile(final Uri uri, String mode) throws FileNotFoundException {

    final Cursor cursor = queryCleared(uri, new String[] {
            Downloads.Impl._DATA, Downloads.Impl.COLUMN_STATUS,
            Downloads.Impl.COLUMN_DESTINATION, Downloads.Impl.COLUMN_MEDIA_SCANNED }, null, null, null);
    final String path;
    final boolean shouldScan;
    try {
        int count = (cursor != null) ? cursor.getCount() : 0;
        if (count != 1) {
            // If there is not exactly one result, throw an appropriate exception.
            ...
        }

        if (cursor.moveToFirst()) {
            final int status = cursor.getInt(1);
            final int destination = cursor.getInt(2);
            final int mediaScanned = cursor.getInt(3);

            path = cursor.getString(0);
            shouldScan = Downloads.Impl.isStatusSuccess(status) &amp;&amp; (
                    destination == Downloads.Impl.DESTINATION_EXTERNAL
                    || destination == Downloads.Impl.DESTINATION_FILE_URI
                    || destination == Downloads.Impl.DESTINATION_NON_DOWNLOADMANAGER_DOWNLOAD)
                    &amp;&amp; mediaScanned != 2;
        } else {
            throw new FileNotFoundException(&quot;Failed moveToFirst&quot;);
        }
    } finally {
        IoUtils.closeQuietly(cursor);
    }

    if (path == null) {
        throw new FileNotFoundException(&quot;No filename found.&quot;);
    }

    final File file = new File(path);
    if (!Helpers.isFilenameValid(getContext(), file)) {
        throw new FileNotFoundException(&quot;Invalid file: &quot; + file);
    }

    final int pfdMode = ParcelFileDescriptor.parseMode(mode);
    if (pfdMode == ParcelFileDescriptor.MODE_READ_ONLY) {
        return ParcelFileDescriptor.open(file, pfdMode);
    } else {
        try {
            // When finished writing, update size and timestamp
            return ParcelFileDescriptor.open(file, pfdMode, mHandler, new OnCloseListener() {
                @Override
                public void onClose(IOException e) {
                    final ContentValues values = new ContentValues();
                    values.put(Downloads.Impl.COLUMN_TOTAL_BYTES, file.length());
                    values.put(Downloads.Impl.COLUMN_LAST_MODIFICATION,
                            System.currentTimeMillis());
                    update(uri, values, null, null);

                    if (shouldScan) {
                        final Intent intent = new Intent(
                                Intent.ACTION_MEDIA_SCANNER_SCAN_FILE);
                        intent.setData(Uri.fromFile(file));
                        getContext().sendBroadcast(intent);
                    }
                }
            });
        } catch (IOException e) {
            throw new FileNotFoundException(&quot;Failed to open for writing: &quot; + e);
        }
    }
}
</code></pre>

<p>To open the downloaded file, do like this:</p>

<pre><code class="language-java">ContentResolver resolver = getContentResolver();
Uri uri = Uri.parse(&quot;content://downloads/download&quot;);
uri = ContentUris.withAppendedId(uri, 9);
InputStream in = resolver.openInputStream(uri);
</code></pre>

<h2 id="to-be-continued">To be Continued&hellip;</h2>

<p>In fact I still don&rsquo;t know how to leverage this vulnerability&hellip;</p>

<h2 id="source-code-path">Source Code Path</h2>

<ul>
<li>DownloadProvider: packages/Providers/DownloadProvider/Src/Com/Android/Providers/Downloads/DownloadProvider.java</li>
<li>DownloadManager: frameworks/base/core/java/android/app/DownloadManager.java</li>
<li>SystemServiceRegistry: frameworks/base/core/java/android/app/SystemServiceRegistry.java</li>
<li>ContextImpl: frameworks/base/core/java/android/app/ContextImpl.java</li>
</ul>

</div>


  <footer class="container">
  <div class="container navigation no-print">
  <h2>Navigation</h2>
  
  

    
    <a class="prev" href="https://zeqiii.github.io/2016/04/08/analysis-of-cve-2016-0847/" title="Analysis of cve-2016-0847">
      Previous
    </a>
    

    

  


</div>

  <div class="container comments">
  <h2>Comments</h2>
  

</div>

</footer>

</article>
      <footer id="main-footer" class="container main_footer">
  

  <div class="container nav foot no-print">
  

  <a class="toplink" href="#">back to top</a>

</div>

  <div class="container credits">
  
<div class="container footline">
  

</div>


  
<div class="container copyright">
  
  &copy; 2016 zeqi


</div>


</div>

</footer>

    </main>
    


<script src="https://zeqiii.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




    
  </body>
</html>

