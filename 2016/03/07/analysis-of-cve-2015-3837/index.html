<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Analysis of cve-2015-3837  &middot; Zeqi&#39;s Blog</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="Analysis of cve-2015-3837" />

<meta name="keywords" content="Vulnerability, ">


<meta property="og:title" content="Analysis of cve-2015-3837  &middot; Zeqi&#39;s Blog ">
<meta property="og:site_name" content="Zeqi&#39;s Blog"/>
<meta property="og:url" content="https://zeqiii.github.io/2016/03/07/analysis-of-cve-2015-3837/" />
<meta property="og:locale" content="en-EN">


<meta property="og:type" content="article" />
<meta property="og:description" content="Analysis of cve-2015-3837"/>
<meta property="og:article:published_time" content="2016-03-07T20:45:41&#43;08:00" />
<meta property="og:article:modified_time" content="2016-03-07T20:45:41&#43;08:00" />

  
    
<meta property="og:article:tag" content="Vulnerability">
    
  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@" />
<meta name="twitter:title" content="Analysis of cve-2015-3837" />
<meta name="twitter:description" content="Analysis of cve-2015-3837" />
<meta name="twitter:url" content="https://zeqiii.github.io/2016/03/07/analysis-of-cve-2015-3837/" />
<meta name="twitter:domain" content="https://zeqiii.github.io/">
  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "Analysis of cve-2015-3837",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+?rel=author"
    },
    "datePublished": "2016-03-07",
    "description": "Analysis of cve-2015-3837",
    "wordCount":  773 
  }
</script>



<link rel="canonical" href="https://zeqiii.github.io/2016/03/07/analysis-of-cve-2015-3837/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://zeqiii.github.io/touch-icon-144-precomposed.png">
<link href="https://zeqiii.github.io/favicon.png" rel="icon">

<meta name="generator" content="Hugo 0.15" />

  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link href='https://fonts.googleapis.com/css?family=Merriweather:300%7CRaleway%7COpen+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://zeqiii.github.io/css/font-awesome.min.css">
<link rel="stylesheet" href="https://zeqiii.github.io/css/style.css">
<link rel="stylesheet" href="https://zeqiii.github.io/css/highlight/default.css">

  
</head>
<body>
  <main id="main-wrapper" class="container main_wrapper has-sidebar">
    <header id="main-header" class="container main_header">
  <div class="container brand">
  <div class="container title h1-like">
  <a class="baselink" href="https://zeqiii.github.io/">
  Zeqi&#39;s Blog

</a>

</div>

  
<div class="container topline">
  

</div>


</div>

  <nav class="container nav primary no-print">
  

<a class="homelink" href="https://zeqiii.github.io/">Home</a>


  
<a href="https://zeqiii.github.io/post" title="Show list of posts">Posts</a>

<a href="https://zeqiii.github.io/tags" title="Show list of tags">Tags</a>

<a href="https://zeqiii.github.io/topics" title="Show list of topics">Topics</a>


</nav>

<div class="container nav secondary no-print">
  
<a id="contact-link-email" class="contact_link" href="mailto:zeqiii@163.com">
  <span class="fa fa-envelope-square"></span><span>email</span></a>



<a id="contact-link-github" class="contact_link" href="https://github.com/zeqiii">
  <span class="fa fa-github-square"></span><span>github</span></a>

















</div>


  

</header>


<article id="main-content" class="container main_content single">
  <header class="container hat">
  <h1>Analysis of cve-2015-3837
</h1>

  <div class="metas">
<time datetime="2016-03-07">7 Mar, 2016</time>


  
    &middot; by zeqi
  
  &middot; Read in about 4 min
  &middot; (773 Words)
  <br>
  
<a class="label" href="https://zeqiii.github.io/tags/vulnerability">Vulnerability</a>



</div>

</header>

  <div class="container content">
  

<h2 id="introduction">Introduction</h2>

<p>CVE-2015-3837 is another java deserialzation vulnerability in android. <a href="http://drops.wooyun.org/papers/10235">Wooyun</a> had analyzed it.</p>

<h2 id="description-on-cve">Description on CVE</h2>

<blockquote>
<p>The OpenSSLX509Certificate class in org/conscrypt/OpenSSLX509Certificate.java in Android before 5.1.1 LMY48I improperly includes certain context data during serialization and deserialization, which allows attackers to execute arbitrary code via an application that sends a crafted Intent, aka internal bug 21437603.</p>
</blockquote>

<p>We know that Google had patched the bug disclosed in CVE-2014-7911, in which <code>ObjectInputStream</code> didn&rsquo;t validate an object can be serialzed or not. The bug can be used to create arbitrary object by deserialization, even the object is not a serializable object, such as <code>android.os.BinderProxy</code>. After being patched, an object will be checked whether it is serializable before deserialization. But if there is an serializable class which overrides <code>finalize()</code> method like BinderProxy, the attacker can still leverage it to execute arbitrary code.</p>

<h2 id="finalize-of-opensslx509certificate">finalize() of OpenSSLX509Certificate</h2>

<p>The location of OpenSSLX509Certificate.java is <code>/external/conscrypt/src/main/java/org/conscrypt/OpenSSLX509Certificate.java</code></p>

<pre><code class="language-java">@Override
protected void finalize() throws Throwable {
    try {
        if (mContext != 0) {
            NativeCrypto.X509_free(mContext);
        }
    } finally {
        super.finalize();
    }
}
</code></pre>

<p>In NativeCrypto.java</p>

<pre><code class="language-java">public static native void X509_free(long x509ctx);
</code></pre>

<p>In org_conscrypt_NativeCrypto.cpp</p>

<pre><code class="language-c">static void NativeCrypto_X509_free(JNIEnv* env, jclass, jlong x509Ref) {

    // cast the mContext to a pointer of X509 struct
    X509* x509 = reinterpret_cast&lt;X509*&gt;(static_cast&lt;uintptr_t&gt;(x509Ref));
    JNI_TRACE(&quot;X509_free(%p)&quot;, x509);

    if (x509 == NULL) {
        jniThrowNullPointerException(env, &quot;x509 == null&quot;);
        JNI_TRACE(&quot;X509_free(%p) =&gt; x509 == null&quot;, x509);
            return;
    }
    X509_free(x509);
}
</code></pre>

<p>Here, I encountered some difficulties finding the definition of <code>X509_free</code>, so I have to look <a href="http://drops.wooyun.org/papers/10235">Wooyun</a> for help. It said that X509_free is defined by nested macros which starts at <code>IMPLEMENT_ASN1_FUNCTIONS(X509)</code> in <code>crypto/asn1/x_x509.c</code>.</p>

<p>I downloaded openssl source code from <a href="https://github.com/openssl/openssl">GitHub</a> and found it in <code>crypto/x509/X_x509.c</code></p>

<pre><code class="language-c">IMPLEMENT_ASN1_FUNCTIONS(X509)
</code></pre>

<p>In <code>include/openssl/Asn1t.h</code></p>

<pre><code class="language-c"># define IMPLEMENT_ASN1_FUNCTIONS(stname) IMPLEMENT_ASN1_FUNCTIONS_fname(stname, stname, stname)

# define IMPLEMENT_ASN1_FUNCTIONS_fname(stname, itname, fname) \
        IMPLEMENT_ASN1_ENCODE_FUNCTIONS_fname(stname, itname, fname) \
        IMPLEMENT_ASN1_ALLOC_FUNCTIONS_fname(stname, itname, fname)

# define IMPLEMENT_ASN1_ALLOC_FUNCTIONS_fname(stname, itname, fname) \
        stname *fname##_new(void) \
        { \
                return (stname *)ASN1_item_new(ASN1_ITEM_rptr(itname)); \
        } \
        void fname##_free(stname *a) \
        { \
                ASN1_item_free((ASN1_VALUE *)a, ASN1_ITEM_rptr(itname)); \
        }

# define IMPLEMENT_ASN1_ENCODE_FUNCTIONS_fname(stname, itname, fname) \
        stname *d2i_##fname(stname **a, const unsigned char **in, long len) \
        { \
                return (stname *)ASN1_item_d2i((ASN1_VALUE **)a, in, len, ASN1_ITEM_rptr(itname));\
        } \
        int i2d_##fname(stname *a, unsigned char **out) \
        { \
                return ASN1_item_i2d((ASN1_VALUE *)a, out, ASN1_ITEM_rptr(itname));\
        }
</code></pre>

<p>So <code>IMPLEMENT_ASN1_FUNCTIONS(X509)</code> equals <code>IMPLEMENT_ASN1_FUNCTIONS_fname(X509, X509, X509)</code></p>

<p>Which equals <code>IMPLEMENT_ASN1_ENCODE_FUNCTIONS_fname(X509, X509, X509);IMPLEMENT_ASN1_ALLOC_FUNCTIONS_fname(X509, X509, X509)</code></p>

<p>Which equals</p>

<pre><code class="language-c">/* encode functions omitted */

X509 *X509_new(void)
{
        return (stname *)ASN1_item_new(ASN1_ITEM_rptr(X509));
}
void X509_free(X509 *a)
{
        ASN1_item_free((ASN1_VALUE *)a, ASN1_ITEM_rptr(X509));
}
</code></pre>

<p>So this is how <code>X509_free()</code> is defined by macros.</p>

<pre><code class="language-c">void ASN1_item_free(ASN1_VALUE *val, const ASN1_ITEM *it)
{
    asn1_item_embed_free(&amp;val, it, 0);
}

static void asn1_item_embed_free(ASN1_VALUE **pval, const ASN1_ITEM *it, int embed)
{
    const ASN1_TEMPLATE *tt = NULL, *seqtt;
    const ASN1_EXTERN_FUNCS *ef;
    const ASN1_AUX *aux = it-&gt;funcs;
    ASN1_aux_cb *asn1_cb;
    int i;

    if (!pval)
        return;
    if ((it-&gt;itype != ASN1_ITYPE_PRIMITIVE) &amp;&amp; !*pval)
        return;
    if (aux &amp;&amp; aux-&gt;asn1_cb)
        asn1_cb = aux-&gt;asn1_cb;
    else
        asn1_cb = 0;

    switch (it-&gt;itype) {

    case ASN1_ITYPE_PRIMITIVE:
        if (it-&gt;templates)
            asn1_template_free(pval, it-&gt;templates);
        else
            asn1_primitive_free(pval, it);
        break;

    case ASN1_ITYPE_MSTRING:
        asn1_primitive_free(pval, it);
        break;

    case ASN1_ITYPE_CHOICE:
        if (asn1_cb) {
            i = asn1_cb(ASN1_OP_FREE_PRE, pval, it, NULL);
            if (i == 2)
                return;
        }
        i = asn1_get_choice_selector(pval, it);
        if ((i &gt;= 0) &amp;&amp; (i &lt; it-&gt;tcount)) {
            ASN1_VALUE **pchval;

            tt = it-&gt;templates + i;
            pchval = asn1_get_field_ptr(pval, tt);
            asn1_template_free(pchval, tt);
        }
        if (asn1_cb)
            asn1_cb(ASN1_OP_FREE_POST, pval, it, NULL);
        if (embed == 0) {
            OPENSSL_free(*pval);
            *pval = NULL;
        }
        break;

    case ASN1_ITYPE_EXTERN:
        ef = it-&gt;funcs;
        if (ef &amp;&amp; ef-&gt;asn1_ex_free)
            ef-&gt;asn1_ex_free(pval, it);
        break;

    case ASN1_ITYPE_NDEF_SEQUENCE:
    case ASN1_ITYPE_SEQUENCE:
        if (asn1_do_lock(pval, -1, it) &gt; 0)
            return;
        if (asn1_cb) {
            i = asn1_cb(ASN1_OP_FREE_PRE, pval, it, NULL);
            if (i == 2)
                return;
        }
        asn1_enc_free(pval, it);
        /*
         * If we free up as normal we will invalidate any ANY DEFINED BY
         * field and we wont be able to determine the type of the field it
         * defines. So free up in reverse order.
         */
        tt = it-&gt;templates + it-&gt;tcount - 1;
        for (i = 0; i &lt; it-&gt;tcount; tt--, i++) {
            ASN1_VALUE **pseqval;
            seqtt = asn1_do_adb(pval, tt, 0);
            if (!seqtt)
                continue;
            pseqval = asn1_get_field_ptr(pval, seqtt);
            asn1_template_free(pseqval, seqtt);
        }
        if (asn1_cb)
            asn1_cb(ASN1_OP_FREE_POST, pval, it, NULL);
        if (embed == 0) {
            OPENSSL_free(*pval);
            *pval = NULL;
        }
        break;
    }
}

</code></pre>

<h2 id="poc">POC</h2>

<p>I write the POC by modifying cve-2014-7911&rsquo;s POC, but it didn&rsquo;t work. I&rsquo;ll continue working on it.</p>

<h2 id="google-s-patch">Google&rsquo;s Patch</h2>

<p>To patch this vulnerability, Google just adds &laquo;transient&raquo; before the definition of the field <code>OpenSSLX509Certificate.mContext</code>, in order to disable it to be serialized.</p>

<h2 id="related-papers">Related Papers</h2>

<p>I&rsquo;ve read the paper <a href="https://www.usenix.org/conference/woot15/workshop-program/presentation/peles">One Class to Rule Them All</a>, where this vulnerability disclosure to public. In this paper, a method is raised to find the vulnerable classes automatically, by defining some criterias and implementing a JDI to check on them. For how to debugging Java programs using Java code, read <a href="/2016/03/10/methods-of-debugging-java-programs/">Methods of Debugging Java Programs</a></p>

</div>


  <footer class="container">
  <div class="container navigation no-print">
  <h2>Navigation</h2>
  
  

    
    <a class="prev" href="https://zeqiii.github.io/2016/03/05/analysis-of-cve-2015-6420/" title="Analysis of cve-2015-6420">
      Previous
    </a>
    

    
    <a class="next" href="https://zeqiii.github.io/2016/03/08/tips-of-c/c-programming/" title="Tips of C/C&#43;&#43; Programming">
      Next
    </a>
    

  


</div>

  <div class="container comments">
  <h2>Comments</h2>
  

</div>

</footer>

</article>
      <footer id="main-footer" class="container main_footer">
  

  <div class="container nav foot no-print">
  

  <a class="toplink" href="#">back to top</a>

</div>

  <div class="container credits">
  
<div class="container footline">
  

</div>


  
<div class="container copyright">
  
  &copy; 2016 zeqi


</div>


</div>

</footer>

    </main>
    


<script src="https://zeqiii.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




    
  </body>
</html>

